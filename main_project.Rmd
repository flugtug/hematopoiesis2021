---
title: "main_project"
author: "Yulia"
date: '2 декабря 2021 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,     # отображение кода в итоговом документе
                      message = FALSE,  # отображение сообщений в итоговом документе
                      error = FALSE,    # отображение ошибок в итоговом документе
                      warning = FALSE,  # отображение предупреждений в итоговом документе
                      cache = FALSE,    # надо ли сохранять код в чанках до их изменений
                      fig.height = 10, # высота рисунка в дюймах
                      fig.width = 10)  # широта рисунка в дюймах


library(tidyverse)
library(dplyr)
library(readxl)
library(ggplot2)
```

## R Markdown
Читаем файл

```{r }
df_raw <- read_excel("./data/raw/reconstitution_v1_enc.xlsx")
str(df_raw)
View(df_raw)
```

## All data modifications

```{r pressure, echo=FALSE}

df <- df_raw  %>%
  # переименование
  rename(Restage_on_TKM_point = "Рестадирование на момент ТКМ (стадия)[ПредТКМэ]" ) %>%
  rename(Age = "Возраст (полных лет) на момент ТКМ") %>% 
  rename(BMI = "Индекс массы тела") %>%
  rename(Conditioning = "Режим кондиционирования[ПредТКМэ]") %>%
  rename(BMT_kind = "Вид ТКМ настоящей [ПТКМ,ПредТКМэ,ПДИТКМ]") %>%
  rename(Source_sc = "Источник[ПредТКМэ,ПТКМ,ПДИ]") %>%
  rename(Donor_sex = "Donor sex") %>%
  rename(Sex = "Пол") %>%
  rename(Disease_state_reconstitution = "State of the disease_reconstitution") %>%
  rename(Reconstitution = "reconstitution") %>%
  rename(HLA_match = "HLA-match") %>%
  rename(Transplantation_date = "Дата ТКМ (из протокола)[ПТКМ,ПДИ]") %>%
  rename(Diagnosis_date = "Дата диагноза [АЗ гем]") %>%
  rename(Leukocyte_recovery = "Восстановление Лейкоциты дата [ТПП, 100 дн]") %>%
  rename(Neutrophil_recovery = "Восстановление Нейтрофилы дата [ТПП,100 дн]") %>%
  rename(Platelet_recovery = "Восстановление Тр20 дата [ТПП, 100 дн]") %>%
  rename(Rejection_date = "Дата отторжения [ТПП,100дн]") %>%
  rename(Patient_ID = "Рег номер пациента") %>%
  rename(TKM_number = "Порядковый номер настоящей трансплантации[ПТКМ,ПДИТКМ]")  %>%
  
  # фильтрация  - убираем лишние строки сразу
  filter(Reconstitution != "death_before" ) %>%
  filter(Diagnosis == "Acute_leukemia" ) %>%
  filter((Source_sc != "cord_blood")) %>%
  filter(TKM_number == 1) %>%

  # Изменение содержимого стобцов
  # BMI
  mutate(BMI = as.numeric(gsub(",", ".", BMI) )) %>%    # заменить точки на запятые
  mutate(BMI = ifelse( (BMI > 100), BMI/10, BMI)) %>%   # исправляем ошибку в данных BMI
  mutate(BMI = ifelse((BMI == 0.0), NA, BMI)) %>%       # 0 в NA
  
  # Reconstitution
  mutate(Reconstitution = factor(ifelse( (Reconstitution == "no"), "no", "yes"))) %>%
  
  # BMT_kind
  mutate(BMT_kind = case_when(
    grepl ("аллогенная_неродственная", BMT_kind) ~ "allogeneic_unrelated",
    grepl ("аллогенная_родственная", BMT_kind) ~ "allogeneic_related",
    grepl ("гаплоидентичная", BMT_kind) ~ "haploidentical"))  %>%
  
  # Restage_on_TKM_point перевод и замена: ремиссия и рецидив,остальные - unknown
  mutate(Restage_on_TKM_point = case_when(
    grepl ("ремиссия", Restage_on_TKM_point) ~ "remission",
    grepl ("рецидив", Restage_on_TKM_point) ~ "relapse",
    TRUE ~ "unknown"))   %>%
  
  # Sex перевод
  mutate(Sex = case_when(
    grepl ("Мужской", Sex) ~ "male",
    grepl ("Женский", Sex) ~ "female")) %>%
  
  # Объединяем виды Source_sc
  mutate(Source_sc = case_when(
    grepl ("BM", Source_sc) ~ "BM",
    grepl ("PBSC", Source_sc) ~ "PBSC")) %>%

  # Новая колонка - комбинаци BMT_kind & HLA_match
  mutate(Transplantation_groups = case_when( 
    (BMT_kind ==  "allogeneic_related") ~ "allogeneic_related", 
    (BMT_kind ==  "haploidentical") ~ "haploidentical",  
    ( (BMT_kind ==  "allogeneic_unrelated") & (HLA_match ==  "matched")) ~  
      "allogeneic_unrelated_matched", 
    ( (BMT_kind ==  "allogeneic_unrelated") & (HLA_match ==  "mismatched")) ~  
      "allogeneic_unrelated_mismatched"  ))  %>%
  
  
  #Отбираем нужные переменных
  select(c(Patient_ID, Donor_sex,  Disease_state_reconstitution,  #Diagnosis
           HLA_match, BMT_kind,
            Restage_on_TKM_point, Age, BMI, Conditioning, 
            Source_sc, Reconstitution, Sex, Transplantation_groups))
            
```

## Смотрим преобразованные данные

```{r }

View(df)
str(df)
```


```{r }
# Collect Patien_IDs
write.table(df$Patient_ID, file='Проект гемопоез, отобранные пациенты.tsv', row.names = FALSE, col.names = FALSE)

```

## В переменной Transplantation_groups - основное отличие между Reconstitution yes/no
Transplantation_groups 
```{r }
# Данные
table(df$Transplantation_groups)
prop.table(table(df$BMT_kind, df$HLA_match))

```
Таблицы сопряженности

```{r }

#Таблицы сопряженности
prop.table(table(df$Reconstitution, df$Transplantation_groups))
#table(df$Reconstitution, df$Transplantation_groups)

```


###Тесты

```{r }

# Тесты
chisq.test(df$Reconstitution, df$Transplantation_groups)
fisher.test(df$Reconstitution, df$Transplantation_groups)
```

###График

```{r }

# График    
ggplot(df, aes(x =  Reconstitution,
               fill = Transplantation_groups )) +
  geom_bar(position = "fill") +
  theme_classic()

```

#Еще одна переменная, по которой есть значимое отличие - Source_sc

```{r }

table(df$Source_sc)
# тут есть  редкие значения BM+BM = 1, BM+PBSC = 1, cord_blood =1, PBSC+PBSC=1
# их дропнуть, преобразовать или так оставить


```

```{r }

#Таблицы сопряженности
prop.table(table(df$Reconstitution, df$Source_sc))
table(df$Reconstitution, df$Source_sc)

# Тесты
chisq.test(df$Reconstitution, df$Source_sc)
fisher.test(df$Reconstitution, df$Source_sc)

# График    
ggplot(df, aes(x =  Reconstitution,
               fill = Source_sc)) +
  geom_bar(position = "fill") +
  theme_classic()


```
# Другие графики 
```{r }

hist(df$Age)
hist(df$BMI)

p1 <- ggplot(df, aes(x = Reconstitution, y = BMI,
                    fill = Reconstitution)) +
  geom_boxplot() +
  geom_jitter()
p1 + scale_fill_brewer(palette = "YlGn") + theme_classic() + stat_compare_means()

#######################################
p2 <- ggplot(df, aes(x = Reconstitution, y = Age,
                    fill = Reconstitution)) +
  geom_boxplot() +
  geom_jitter()
p2 + scale_fill_brewer(palette = "GnBu") + theme_classic() + stat_compare_means()

#######################################
p3 <- ggplot(df, aes(x =  Reconstitution, y = BMI)) +
  geom_violin(fill = "yellow",
              alpha = 0.5,
              width = 0.6) +
  geom_boxplot(fill = "lightgreen",
               width = 0.3)
p3 + scale_fill_brewer(palette = "YlGn") + theme_classic() + stat_compare_means()
  

######################################
p4 <- ggplot(df, aes(x = Reconstitution,
               fill = Donor_sex)) +
  geom_bar()
p4 + scale_fill_brewer(palette = "GnBu") + theme_classic()


######################################
p5 <- ggplot(df, aes(x = Reconstitution,
               fill = Sex)) +
  geom_bar()
p5 + scale_fill_brewer(palette = "GnBu") + theme_classic()

######################################
p6 <- ggplot(df, aes(x =  Reconstitution,
               fill = Sex)) +
  geom_bar(position = "fill")
p6 + scale_fill_brewer(palette = "GnBu") + theme_classic()

# посчитать тест на значимость различий

######################################
p7 <- ggplot(df, aes(x =  Reconstitution,
               fill = Restage_on_TKM_point)) +
      geom_bar(position = "fill")
p7 + scale_fill_brewer(palette = "YlGn") + theme_classic()

# посчитать тест на значимость различий

######################################
p8 <- ggplot(df, aes(x =  Reconstitution,
               fill = HLA_match)) +
  geom_bar(position = "fill") 
p8 + scale_fill_brewer(palette = "Paired") + theme_classic()

######################################
p9 <- ggplot(df, aes(x =  Reconstitution,
               fill = Disease_state_reconstitution)) +
  geom_bar(position = "fill")
p9 + scale_fill_brewer(palette = "Paired") + theme_classic()


######################################
p10 <- ggplot(df, aes(x =  Reconstitution,
               fill = Conditioning)) +
  geom_bar(position = "fill")
p10 + scale_fill_brewer(palette = "YlGn") + theme_classic()

```


##################################################################
# Add the second dataset with  blood analysis
## Days 10, 15, 20, 25, boxplots
```{r }
df_raw2 <- read_excel("./data/raw/blood_tests.xlsx")
View(df_raw2)
str(df_raw2)

# colect columns and remove duplicated days for a patient
dfblood_some_days <- df_raw2 %>%
  dplyr::filter(day_after_HSCT %in% c(10, 15, 20, 25)) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID)  

View(dfblood_some_days)

# check for duplicates
length(unique(dfblood_some_days$Patient_ID))
length(dfblood_some_days$Patient_ID)

# Merge with the main dataset
combined_some_days  <- merge(df, dfblood_some_days, by = "Patient_ID")
View(combined_some_days)

table(combined_some_days$Reconstitution)
table(combined_some_days$day_after_HSCT)
```


## Boxplots
```{r }
ggplot(combined_some_days, aes(x = , y = PLT, fill = Reconstitution)) +  
  geom_boxplot() +  
  facet_grid(. ~ day_after_HSCT, scales="free_x", space="free_x")  +
  scale_y_log10() +
  ylab("log10(PLT)") + 
  ggtitle("PLT difference") +
  theme_bw() +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 20), plot.title = element_text(size = 20))



ggplot(combined_some_days, aes(x = , y = WBC, fill = Reconstitution)) +  
  geom_boxplot() +  
  facet_grid(. ~ day_after_HSCT, scales="free_x", space="free_x")  +
  #scale_y_continuous(limits = quantile(day10$WBC, c(0.1, 0.9))) +
  scale_y_log10() +
  ylab("log10(WBC)") + 
  ggtitle("WBC difference") +
  theme_bw() +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 20), plot.title = element_text(size = 20)) 
  

ggplot(day10, aes(x = Reconstitution, y = PLT)) +
  geom_boxplot(color="red",
               fill='grey') +
  geom_jitter(width = 0.1,
              alpha = 0.31,
              color = "black") +
  theme_classic()
```



## All days before 35 - geom_errorbars
```{r }
#!!!!!!!!!!!!!!!!!!!!!!!!!
# this block uses library(Rmisc), that conflict with dplyr
# in case of errors use dplyr::rename instead of rename
library(Rmisc)
#!!!!!!!!!!!!!!!!!!!!!!!!!

dfblood_all_days <- df_raw2 %>%
  dplyr::filter(day_after_HSCT < 35 ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::rename(Patient_ID = "ID")

day_all <- merge(df, dfblood_all_days, by = "Patient_ID")
#view(day_all)
#table(day_all$Reconstitution)
#table(dfblood_all_days$day_after_HSCT)

stat_WBC <- summarySE(day_all, 
                      measurevar="WBC", 
                      groupvar=c('day_after_HSCT', 'Reconstitution'), na.rm = TRUE)
#view(stat_WBC)

ggplot( stat_WBC, aes(x=day_after_HSCT, y=WBC, colour=Reconstitution)) + 
  geom_errorbar(aes(ymin=WBC-se, ymax=WBC+se), width=0.5, size=0.8) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = seq(0, 40, by = 5))+
  ggtitle("mean WBC changes by day") +
  theme_bw() +
  theme(axis.title = element_text(size = 20), 
        axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 30),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 15)) 

stat_PLT <- summarySE(day_all, 
                      measurevar="PLT", 
                      groupvar=c('day_after_HSCT', 'Reconstitution'), na.rm = TRUE)
#view(stat_PLT)

ggplot( stat_PLT, aes(x=day_after_HSCT, y=PLT, colour=Reconstitution)) + 
  geom_errorbar(aes(ymin=PLT-se, ymax=PLT+se), width=0.2, size=0.5) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = seq(0, 40, by = 5))+
  ggtitle("mean PLT, changes by day") +
  theme_bw() +
  theme(axis.title = element_text(size = 20), 
        axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 30),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 15)) 

```



## Regressions - the first try, with missing values
### Prepare data (4 merges)
```{r }
# Test and train
df_raw2 <- read_excel("./data/raw/blood_tests.xlsx")
View(df_raw2)
str(df_raw2)

###################DAY10
# colect columns and remove duplicated days for a patient
day10 <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == 10 ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename(WBC_day10 = WBC) %>%
  dplyr::rename(PLT_day10 = PLT) %>%
  dplyr::select(Patient_ID, WBC_day10, PLT_day10)

View(day10)

# check for duplicates
length(unique(day10$Patient_ID))
length(day10$Patient_ID)

# Merge with the main dataset
combined_day_10  <- merge(df, day10, by = "Patient_ID", all=T)
dim(df)
dim(combined_day_10)

###################DAY15
day15 <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == 15 ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename(WBC_day15 = WBC) %>%
  dplyr::rename(PLT_day15 = PLT) %>%
  dplyr::select(Patient_ID, WBC_day15, PLT_day15)

View(day15)

# check for duplicates
length(unique(day15$Patient_ID))
length(day15$Patient_ID)

# Merge with the main dataset
combined_day_10_15  <- merge(combined_day_10, day15, by = "Patient_ID", all=T)
dim(df)
dim(combined_day_10_15)



###################DAY20
day20 <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == 20 ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename(WBC_day20 = WBC) %>%
  dplyr::rename(PLT_day20 = PLT) %>%
  dplyr::select(Patient_ID, WBC_day20, PLT_day20)

View(day20)

# check for duplicates
length(unique(day20$Patient_ID))
length(day20$Patient_ID)

# Merge with the main dataset
combined_day_10_15_20  <- merge(combined_day_10_15, day20, by = "Patient_ID", all=T)
dim(df)
dim(combined_day_10_15_20)



###################DAY25
day25 <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == 25 ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename(WBC_day25 = WBC) %>%
  dplyr::rename(PLT_day25 = PLT) %>%
  dplyr::select(Patient_ID, WBC_day25, PLT_day25)

View(day25)

# check for duplicates
length(unique(day25$Patient_ID))
length(day25$Patient_ID)

# Merge with the main dataset
combined_day_10_15_20_25  <- merge(combined_day_10_15_20, day25, by = "Patient_ID", all=T)
dim(df)
dim(combined_day_10_15_20_25)

```


### Split test and train
```{r }

response.column = 'Reconstitution'
response = combined_day_10_15_20_25[[response.column]]
table(response)

set.seed(323) #setting random number
index <- sample(2, nrow(combined_day_10_15_20_25), prob = c(0.65, 0.35), replace = TRUE)
default_trn <- combined_day_10_15_20_25[index==1, ] # Train data
default_tst <- combined_day_10_15_20_25[index == 2, ] # Test data 

table(default_trn$Reconstitution)
table(default_tst$Reconstitution)

##################################################################
```
### Models
```{r }
#########################################################################
# Regression
# https://www.datacamp.com/community/tutorials/logistic-regression-R
# Строим модель
model0 <- glm(Reconstitution ~ Transplantation_groups + Source_sc + BMI,# + Age, 
               data = default_trn, family = binomial)

model_day10 <- glm(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day10 + WBC_day10,  
               data = default_trn, family = binomial)

model_day15 <- glm(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day15 + WBC_day15,
               data = default_trn, family = binomial)

model_day20 <- glm(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day20 + WBC_day20, 
               data = default_trn, family = binomial)

model_day25 <- glm(Reconstitution ~  Transplantation_groups + Source_sc + BMI + PLT_day25 + WBC_day25,
               data = default_trn, family = binomial)

# смотрим на модель
summary(model_day15)
#coef(glm.fit)
#head(predict(glm.fit))
#glm.probs <- predict(glm.fit, type = "response")
#glm.probs[1:10]

# Как она предсказывает на трейне, порог тут 0,9 - можно менять
#glm.pred <- ifelse(glm.probs > 0.9, "yes", "no")
#attach(default_trn)
#table(glm.pred, Reconstitution)
#table(glm.pred, default_trn$Reconstitution)
##################################################################
```


### Строим ROC/AUC на тестовой выборке
```{r }
#########################################################################

library(pROC)
test_model0 = predict(model0, newdata = default_tst, type = "response")
test_model_day10 = predict(model_day10, newdata = default_tst, type = "response")
test_model_day15 = predict(model_day15, newdata = default_tst, type = "response")
test_model_day20 = predict(model_day20, newdata = default_tst, type = "response")
test_model_day25 = predict(model_day25, newdata = default_tst, type = "response")


plot.roc(default_tst$Reconstitution, test_model0, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE)
plot.roc(default_tst$Reconstitution, test_model_day10, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=40)
plot.roc(default_tst$Reconstitution, test_model_day15, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(default_tst$Reconstitution, test_model_day20, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(default_tst$Reconstitution, test_model_day25, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)

# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "Models with WBC and PLT")

```


# GLM with  Cross-validation with caret using caret
## Split test and train
```{r }
# See - https://www.kaggle.com/tentotheminus9/quick-glm-using-caret

library('caret')
response.column = 'Reconstitution'
response = combined_day_10_15_20_25[[response.column]]
table(response)


set.seed(200)
trainIndex <- createDataPartition(combined_day_10_15_20_25$Reconstitution, 
                                  p = .8, list = FALSE, times = 1)

train_data = combined_day_10_15_20_25[ trainIndex,]
test_data  = combined_day_10_15_20_25[-trainIndex,]

table(train_data$Reconstitution)
table(test_data$Reconstitution)

##################################################################
```

### Cross-validation
```{r }
set.seed(15) #Set seed to ensure reproducible results

fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 20, 
                          summaryFunction = twoClassSummary, 
                           classProbs = TRUE, 
                          savePredictions = TRUE)
ctrl = trainControl(method="cv", 
                     summaryFunction=twoClassSummary, 
                     classProbs=T,
                     savePredictions = T)
```

### Models
```{r }
#########################################################################
# Regression
# https://www.datacamp.com/community/tutorials/logistic-regression-R
# Строим модель


model0 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + BMI, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               #preProcess = c('center', 'scale'),
               na.action = na.pass,
               trControl = fitControl,
               metric = 'ROC')

#summary(model0)

model_day10 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day10 + WBC_day10, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               #preProcess = c('center', 'scale'),
               na.action = na.pass,
               trControl = fitControl,
               metric = 'ROC')


model_day15 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day15 + WBC_day15, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               #preProcess = c('center', 'scale'),
               na.action = na.pass,
               trControl = fitControl,
               metric = 'ROC')

model_day20 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day20 + WBC_day20, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               #preProcess = c('center', 'scale'),
               na.action = na.pass,
               trControl = fitControl,
               metric = 'ROC')

model_day25 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + BMI + PLT_day25 + WBC_day25, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               #preProcess = c('center', 'scale'),
               na.action = na.pass,
               trControl = fitControl,
               metric = 'ROC')

# смотрим на модель
#summary(model_day25)

##################################################################
```


### Строим ROC/AUC на тестовой выборке
```{r }
#########################################################################

library(pROC)
test_model0 = predict(model0, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day10 = predict(model_day10, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day15 = predict(model_day15, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day20 = predict(model_day20, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day25 = predict(model_day25, newdata = test_data, type = "prob", na.action=na.pass) 

plot.roc(test_data$Reconstitution, test_model0$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE)

plot.roc(test_data$Reconstitution, test_model_day10$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=40)

plot.roc(test_data$Reconstitution, test_model_day15$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data$Reconstitution, test_model_day20$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(test_data$Reconstitution, test_model_day25$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)

# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "Models with WBC and PLT")

```


# Replase missing walues of the blood test with previous not NA
```{r }
#########################################################################

df_raw2 <- read_excel("./data/raw/blood_tests.xlsx")

df_new <- df
for (day in 1:30) {
  day_df <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == day ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename_at(vars(c(WBC, PLT)),function(x) paste0(x, day)) %>%
  dplyr::select(-day_after_HSCT)
  #print(head(day_df))
  
  df_new  <- merge(df_new, day_df, by = "Patient_ID", all=T)
}
view(df_new)

df_new_no_na <- df_new
for (day in 2:30) { 
  
 WBC_now <- paste0("WBC", day)
 WBC_prev <- paste0("WBC", day-1)
 PLT_now <- paste0("PLT", day)
 PLT_prev <- paste0("PLT", day-1)
 #print(c(WBC_now,  WBC_prev))
 
 df_new_no_na <- df_new_no_na %>% 
 dplyr::mutate(!!WBC_now := coalesce(!!sym(WBC_now), !!sym(WBC_prev)))    %>%  
 dplyr::mutate(!!PLT_now := coalesce(!!sym(PLT_now), !!sym(PLT_prev))) 
 
} 

View(dfblood_some_days)

some_days_no_na <- df_new_no_na %>%
  dplyr::select(c(Patient_ID, Reconstitution, Transplantation_groups, Source_sc,  Age, 
                  Conditioning, WBC10, WBC15, WBC20, WBC25,
                  PLT10, PLT15, PLT20, PLT25))

dim(na.omit(some_days_no_na))
dim(some_days_no_na)
some_days_no_na = na.omit(some_days_no_na)

sapply(some_days_no_na, function(x) sum(is.na(x)))

```

# Replase missing walues of the blood test with previous not NA
```{r }
#########################################################################
df_raw2 <- read_excel("./data/raw/blood_tests.xlsx")


## First caombine all days from 1 to 30 by patient
df_new <- df
for (day in 1:30) {
  day_df <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == day ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename_at(vars(c(WBC, PLT)),function(x) paste0(x, day)) %>%
  dplyr::select(-day_after_HSCT)
  #print(head(day_df))
  df_new  <- merge(df_new, day_df, by = "Patient_ID", all=T)
}
view(df_new)


# Replase missing values with previous from 2 to 30
## Function coalesce
df_new_no_na <- df_new
for (day in 2:30) { 
 WBC_now <- paste0("WBC", day)
 WBC_prev <- paste0("WBC", day-1)
 PLT_now <- paste0("PLT", day)
 PLT_prev <- paste0("PLT", day-1)
 #print(c(WBC_now,  WBC_prev))
 
 df_new_no_na <- df_new_no_na %>% 
 dplyr::mutate(!!WBC_now := coalesce(!!sym(WBC_now), !!sym(WBC_prev)))    %>%  
 dplyr::mutate(!!PLT_now := coalesce(!!sym(PLT_now), !!sym(PLT_prev))) 
 
} 
View(dfblood_some_days)

## Select our days of interest
some_days_no_na <- df_new_no_na %>%
  dplyr::select(c(Patient_ID, Reconstitution, Transplantation_groups, Source_sc,  Age, 
                  Conditioning, WBC10, WBC15, WBC20, WBC25,
                  PLT10, PLT15, PLT20, PLT25))

dim(na.omit(some_days_no_na))
dim(some_days_no_na)
some_days_no_na = na.omit(some_days_no_na)

sapply(some_days_no_na, function(x) sum(is.na(x)))

```


# GLM without missing values
### createDataPartition
```{r }
set.seed(200)
trainIndex <- createDataPartition(some_days_no_na$Reconstitution, 
                                  p = .8, list = FALSE, times = 1)

train_data = some_days_no_na[ trainIndex,]
test_data  = some_days_no_na[-trainIndex,]

table(train_data$Reconstitution)
table(test_data$Reconstitution)

##################################################################
```

### Cross-validation
```{r }
set.seed(15) #Set seed to ensure reproducible results

fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 20, 
                          summaryFunction = twoClassSummary, 
                           classProbs = TRUE, 
                          savePredictions = TRUE)
```

### Models
```{r }
#########################################################################
model0 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

#summary(model0)

model_day10 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT10 + WBC10, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')


model_day15 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age  + PLT15 + WBC15, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

model_day20 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT20 + WBC20, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

model_day25 <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT25 + WBC25, 
               data = train_data, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

# смотрим на модель
#summary(model_day25)
```
##################################################################


### Строим ROC/AUC на тестовой выборке
```{r }
#########################################################################
#library(pROC)
test_model0 = predict(model0, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day10 = predict(model_day10, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day15 = predict(model_day15, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day20 = predict(model_day20, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day25 = predict(model_day25, newdata = test_data, type = "prob", na.action=na.pass) 

plot.roc(test_data$Reconstitution, test_model0$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE, print.auc.y=40)

plot.roc(test_data$Reconstitution, test_model_day10$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=35)

plot.roc(test_data$Reconstitution, test_model_day15$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data$Reconstitution, test_model_day20$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=25)
plot.roc(test_data$Reconstitution, test_model_day25$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)

# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "GLM with WBC and PLT")

```

#RANGER

```{r }
library(ranger)

model0_ranger <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age, 
               data = train_data, 
               method = 'ranger',
               trControl = fitControl,
               metric = 'ROC')

#summary(model0)

model_day10_ranger <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT10 + WBC10, 
               data = train_data, 
               method = 'ranger',
               trControl = fitControl,
               metric = 'ROC')


model_day15_ranger <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age  + PLT15 + WBC15, 
               data = train_data, 
               method = 'ranger',
               trControl = fitControl,
               metric = 'ROC')

model_day20_ranger <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT20 + WBC20, 
               data = train_data, 
               method = 'ranger',
               trControl = fitControl,
               metric = 'ROC')

model_day25_ranger <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT25 + WBC25, 
               data = train_data, 
               method = 'ranger',
               trControl = fitControl,
               metric = 'ROC')


##################################################################
```


### Строим ROC/AUC на тестовой выборке
```{r }
#########################################################################

library(pROC)
test_model0_ranger = predict(model0_ranger, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day10_ranger = predict(model_day10_ranger, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day15_ranger = predict(model_day15_ranger, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day20_ranger = predict(model_day20_ranger, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day25_ranger = predict(model_day25_ranger, newdata = test_data, type = "prob", na.action=na.pass) 

plot.roc(test_data$Reconstitution, test_model0_ranger$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE)

plot.roc(test_data$Reconstitution, test_model_day10_ranger$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=40)

plot.roc(test_data$Reconstitution, test_model_day15_ranger$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data$Reconstitution, test_model_day20_ranger$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(test_data$Reconstitution, test_model_day25_ranger$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)

# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "Models ranger with WBC and PLT")

```


#KNN

```{r }
model0_knn <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age, 
               data = train_data, 
               method = 'knn',
               trControl = fitControl,
               metric = 'ROC', 
               preProcess = c("center","scale","pca"))

#summary(model0)

model_day10_knn <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT10 + WBC10, 
               data = train_data, 
               method = 'knn',
               trControl = fitControl,
               metric = 'ROC', 
               preProcess = c("center","scale","pca"))


model_day15_knn <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age  + PLT15 + WBC15, 
               data = train_data, 
               method = 'knn',
               trControl = fitControl,
               metric = 'ROC', 
               preProcess = c("center","scale","pca"))

model_day20_knn <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT20 + WBC20, 
               data = train_data, 
               method = 'knn',
               trControl = fitControl,
               metric = 'ROC', 
               preProcess = c("center","scale","pca"))

model_day25_knn <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT25 + WBC25, 
               data = train_data, 
               method = 'knn',
               trControl = fitControl,
               metric = 'ROC', 
               preProcess = c("center","scale","pca"))


##################################################################
```


#### Строим ROC/AUC на тестовой выборке
```{r }
#########################################################################

library(pROC)
test_model0_knn = predict(model0_knn, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day10_knn = predict(model_day10_knn, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day15_knn = predict(model_day15_knn, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day20_knn = predict(model_day20_knn, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day25_knn = predict(model_day25_knn, newdata = test_data, type = "prob", na.action=na.pass) 

plot.roc(test_data$Reconstitution, test_model0_knn$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE)

plot.roc(test_data$Reconstitution, test_model_day10_knn$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=40)

plot.roc(test_data$Reconstitution, test_model_day15_knn$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data$Reconstitution, test_model_day20_knn$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(test_data$Reconstitution, test_model_day25_knn$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)

# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "Models KNN with WBC and PLT")

```

###XGBOOST - eXtreme Gradient BOOSTing ----

```{r }

xgb_grid_1  <-  expand.grid(
  nrounds = 50,
  eta = c(0.03),
  max_depth = 1,
  gamma = 0,
  colsample_bytree = 0.6,
  min_child_weight = 1,
  subsample = 0.5
)

model0_xgb <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age, 
               data = train_data, 
               trControl = fitControl,
               metric = 'ROC', 
               method = "xgbTree",
               tuneGrid=xgb_grid_1,
               preProcess = c("center","scale","pca"))

#summary(model0)

model_day10_xgb <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT10 + WBC10, 
               data = train_data, 
               trControl = fitControl,
               metric = 'ROC', 
               method = "xgbTree",
               tuneGrid=xgb_grid_1,
               preProcess = c("center","scale","pca"))


model_day15_xgb <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age  + PLT15 + WBC15, 
               data = train_data, 
              trControl = fitControl,
               metric = 'ROC', 
               method = "xgbTree",
               tuneGrid=xgb_grid_1,
               preProcess = c("center","scale","pca"))

model_day20_xgb <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT20 + WBC20, 
               data = train_data, 
               trControl = fitControl,
               metric = 'ROC', 
               method = "xgbTree",
               tuneGrid=xgb_grid_1,
               preProcess = c("center","scale","pca"))

model_day25_xgb <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT25 + WBC25, 
               data = train_data, 
               trControl = fitControl,
               metric = 'ROC', 
               method = "xgbTree",
               tuneGrid=xgb_grid_1, 
               preProcess = c("center","scale","pca"))

```
##################################################################


#### ROC
```{r }
#########################################################################

test_model0_xgb = predict(model0_xgb, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day10_xgb = predict(model_day10_xgb, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day15_xgb = predict(model_day15_xgb, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day20_xgb = predict(model_day20_xgb, newdata = test_data, type = "prob", na.action=na.pass) 
test_model_day25_xgb = predict(model_day25_xgb, newdata = test_data, type = "prob", na.action=na.pass) 


plot.roc(test_data$Reconstitution, test_model0_xgb$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE)
plot.roc(test_data$Reconstitution, test_model_day10_xgb$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=40)
plot.roc(test_data$Reconstitution, test_model_day15_xgb$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data$Reconstitution, test_model_day20_xgb$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(test_data$Reconstitution, test_model_day25_xgb$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)


# Add legend
legend("bottomright",
       legend=c("Day_0", "Day_10", "Day_15", "Day_20", "Day_25"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "XGB with WBC and PLT")

```



# See what happend between day 15 and 20
```{r }
#########################################################################
# Regression
# https://www.datacamp.com/community/tutorials/logistic-regression-R
# Строим модель

df_raw2 <- read_excel("./data/raw/blood_tests.xlsx")

df_new <- df
for (day in 1:30) {
  day_df <- df_raw2 %>%
  dplyr::filter(day_after_HSCT  == day ) %>%
  dplyr::select(c(ID, WBC, PLT, day_after_HSCT)) %>%
  dplyr::group_by(ID, day_after_HSCT) %>%
  dplyr::summarise(WBC=mean(WBC), PLT = mean(PLT)) %>%
  dplyr::rename(Patient_ID = ID) %>%
  dplyr::rename_at(vars(c(WBC, PLT)),function(x) paste0(x, day)) %>%
  dplyr::select(-day_after_HSCT)
  #print(head(day_df))
  
  df_new  <- merge(df_new, day_df, by = "Patient_ID", all=T)
}
#view(df_new)

df_new_no_na <- df_new
for (day in 2:21) { 
  
 WBC_now <- paste0("WBC", day)
 WBC_prev <- paste0("WBC", day-1)
 PLT_now <- paste0("PLT", day)
 PLT_prev <- paste0("PLT", day-1)
 #print(c(WBC_now,  WBC_prev))
 
 df_new_no_na <- df_new_no_na %>% 
 dplyr::mutate(!!WBC_now := coalesce(!!sym(WBC_now), !!sym(WBC_prev)))    %>%  
 dplyr::mutate(!!PLT_now := coalesce(!!sym(PLT_now), !!sym(PLT_prev))) 
 
} 


day_15to_20_no_na <- df_new_no_na %>%
  dplyr::select(c(Patient_ID, Reconstitution, Transplantation_groups, Source_sc,  Age, 
                  Conditioning, WBC15, WBC16, WBC17, WBC18, WBC19, WBC20,
                  PLT15, PLT16, PLT17, PLT18, PLT19, PLT20))

dim(na.omit(day_15to_20_no_na))
dim(day_15to_20_no_na)
day_15to_20_no_na= na.omit(day_15to_20_no_na)


```

### GLM between day 15 and 20

```{r }
# See - https://www.kaggle.com/tentotheminus9/quick-glm-using-caret

library('caret')
set.seed(250)
trainIndex <- createDataPartition(day_15to_20_no_na$Reconstitution, 
                                  p = .8, list = FALSE, times = 1)

train_data_15_20 = day_15to_20_no_na[ trainIndex,]
test_data_15_20  = day_15to_20_no_na[-trainIndex,]

table(train_data_15_20$Reconstitution)
table(test_data_15_20 $Reconstitution)

##################################################################
```


### Cross-validation
```{r }
set.seed(15) #Set seed to ensure reproducible results

fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 20, 
                          summaryFunction = twoClassSummary, 
                           classProbs = TRUE, 
                          savePredictions = TRUE)
```
### Models
```{r }
#########################################################################
# Regression
# https://www.datacamp.com/community/tutorials/logistic-regression-R
# Строим модель

model_day15_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT15 + WBC15, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')


model_day16_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT16 + WBC16, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')


model_day17_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT17 + WBC17, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

model_day18_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT18 + WBC18, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

model_day19_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT19 + WBC19, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

model_day20_glm <- caret::train(Reconstitution ~ Transplantation_groups + Source_sc + Age + PLT20 + WBC20, 
               data = train_data_15_20, 
               method = 'glm',
               family = "binomial",
               trControl = fitControl,
               metric = 'ROC')

```
##################################################################


### ROC/AUC на тестовой выборке
```{r }
#########################################################################

library(pROC)
test_model_day15 = predict(model_day15_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass) 
test_model_day16 = predict(model_day16_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass) 
test_model_day17 = predict(model_day17_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass) 
test_model_day18 = predict(model_day18_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass)
test_model_day19 = predict(model_day19_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass) 
test_model_day20 = predict(model_day20_glm, newdata = test_data_15_20, type = "prob", na.action=na.pass) 

plot.roc(test_data_15_20$Reconstitution, test_model_day15$yes, legacy.axes=FALSE, percent=TRUE, col="red4", lwd=2, print.auc=TRUE, print.auc.y=35)
plot.roc(test_data_15_20$Reconstitution, test_model_day16$yes, percent=TRUE, col="goldenrod", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=30)
plot.roc(test_data_15_20$Reconstitution, test_model_day17$yes, percent=TRUE, col="slategrey", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=25)
plot.roc(test_data_15_20$Reconstitution, test_model_day18$yes, percent=TRUE, col="seagreen", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=20)
plot.roc(test_data_15_20$Reconstitution, test_model_day19$yes, percent=TRUE, col="navy", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=15)
plot.roc(test_data_15_20$Reconstitution, test_model_day20$yes, percent=TRUE, col="green", lwd=2,  add=TRUE, print.auc=TRUE, print.auc.y=10)

# Add legend
legend("bottomright",
       legend=c("Day_15", "Day_16", "Day_17", "Day_18", "Day_19", "Day_20"),
       col=c("red4", "goldenrod", "slategrey", "seagreen", "navy", "green"),
       lwd=4, cex =0.7, xpd = TRUE)# horiz = TRUE)
title(main = "Models with WBC and PLT")

```
